{"version":3,"sources":["../../../../../assets/Script/Common/assets/Script/Common/UpdateVersion.ts"],"names":[],"mappings":";;;;;AAAA;;;;;;;;;;;;;;;;;;;;;;;GAuBG;AACH;IAwBI;IAEA,CAAC;IAEM,6BAAK,GAAZ;QACI,EAAE,CAAA,CAAC,CAAC,EAAE,IAAI,CAAC,EAAE,CAAC,GAAG,CAAC,QAAQ,CAAC,CAC3B,CAAC;YACG,EAAE,CAAC,GAAG,CAAC,SAAS,CAAC,CAAA;YACjB,IAAI,CAAC,eAAe,IAAI,IAAI,CAAC,eAAe,EAAE,CAAC;YAC/C,MAAM,CAAC;QACX,CAAC;QAED,IAAI,GAAG,GAAU,oDAAoD,CAAC;QACtE,IAAI,MAAM,GAAU,GAAG,CAAC,SAAS,CAAC,eAAe,EAAE,GAAG,QAAQ,CAAC;QAC/D,OAAO,CAAC,GAAG,CAAC,cAAc,EAAE,MAAM,CAAC,CAAC;QAEpC,uBAAuB;QACvB,IAAI,CAAC,aAAa,GAAG,IAAI,GAAG,CAAC,aAAa,CAAC,kBAAkB,EAAE,MAAM,CAAC,CAAC;QACvE,IAAI,CAAC,mBAAmB,GAAG,IAAI,GAAG,CAAC,0BAA0B,CAAC,IAAI,CAAC,aAAa,EAAE,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;QACzG,EAAE,CAAC,YAAY,CAAC,WAAW,CAAC,IAAI,CAAC,mBAAmB,EAAE,CAAC,CAAC,CAAC;QACzD,IAAI,CAAC,aAAa,CAAC,MAAM,EAAE,CAAC;QAE5B,kBAAkB;QAClB,IAAI,oBAAoB,GAAG,EAAE,CAAC,GAAG,CAAC,YAAY,CAAC,OAAO,CAAC,sBAAsB,CAAC,CAAC;QAC/E,EAAE,CAAA,CAAC,CAAC,oBAAoB,CAAC,CACzB,CAAC;YACG,gFAAgF;YAChF,oBAAoB,GAAG,MAAM,CAAC;YAC9B,0BAA0B;YAC1B,IAAI,WAAW,GAAiB,GAAG,CAAC,SAAS,CAAC,cAAc,EAAE,CAAC;YAE/D,iFAAiF;YACjF,WAAW,CAAC,OAAO,CAAC,oBAAoB,CAAC,CAAC;YAE1C,GAAG,CAAA,CAAU,UAAW,EAAX,2BAAW,EAAX,yBAAW,EAAX,IAAW;gBAApB,IAAI,CAAC,oBAAA;gBAEL,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;aACb;YAED,GAAG,CAAC,SAAS,CAAC,cAAc,CAAC,WAAW,CAAC,CAAA;YACzC,EAAE,CAAC,GAAG,CAAC,YAAY,CAAC,OAAO,CAAC,sBAAsB,EAAE,IAAI,CAAC,SAAS,CAAC,WAAW,CAAC,CAAC,CAAC;QACrF,CAAC;IACL,CAAC;IAES,6BAAK,GAAf,UAAgB,CAAwB;QACpC,OAAO,CAAC,GAAG,CAAC,YAAY,EAAE,CAAC,CAAC,YAAY,EAAE,EAAE,CAAC,CAAC,UAAU,EAAE,CAAC,CAAC;QAC5D,MAAM,CAAA,CAAC,CAAC,CAAC,YAAY,EAAE,CAAC,CACxB,CAAC;YACG,KAAK,aAAa,CAAC,uBAAuB;gBACtC,KAAK,CAAC;YACV,KAAK,aAAa,CAAC,uBAAuB;gBACtC,KAAK,CAAC;YACV,KAAK,aAAa,CAAC,oBAAoB;gBACnC,KAAK,CAAC;YACV,KAAK,aAAa,CAAC,iBAAiB;gBAChC,KAAK,CAAC;YACV,KAAK,aAAa,CAAC,kBAAkB;gBACjC,EAAE,CAAC,GAAG,CAAC,6BAA6B,CAAC,CAAC;gBACtC,IAAI,CAAC,eAAe,IAAI,IAAI,IAAI,IAAI,CAAC,eAAe,EAAE,CAAC;gBACvD,KAAK,CAAC;YACV,KAAK,aAAa,CAAC,kBAAkB;gBACjC,EAAE,CAAC,GAAG,CAAC,YAAY,EAAE,CAAC,CAAC,UAAU,EAAE,EAAE,CAAC,CAAC,aAAa,EAAE,EAAE,IAAI,CAAC,aAAa,CAAC,CAAC;gBAC5E,EAAE,CAAA,CAAC,IAAI,CAAC,aAAa,IAAI,IAAI,CAAC,CAC9B,CAAC;oBACG,IAAI,CAAC,aAAa,CAAC,CAAC,CAAC,UAAU,EAAE,EAAE,CAAC,CAAC,aAAa,EAAE,CAAC,CAAC;gBAC1D,CAAC;gBACD,KAAK,CAAC;YACV,KAAK,aAAa,CAAC,aAAa;gBAC5B,KAAK,CAAC;YACV,KAAK,aAAa,CAAC,cAAc;gBAC7B,KAAK,CAAC;YACV,KAAK,aAAa,CAAC,eAAe;gBAC9B,EAAE,CAAC,GAAG,CAAC,oBAAoB,CAAC,CAAC;gBAC7B,IAAI,CAAC,OAAO,EAAE,CAAC;gBACf,KAAK,CAAC;YACV,KAAK,aAAa,CAAC,aAAa;gBAC5B,KAAK,CAAC;YACV,KAAK,aAAa,CAAC,eAAe;gBAC9B,KAAK,CAAC;QACd,CAAC;IACL,CAAC;IAEM,+BAAO,GAAd;QACI,EAAE,CAAC,WAAW,CAAC,OAAO,EAAE,CAAC;QACzB,IAAI,CAAC,OAAO,EAAE,CAAC;QAEf,EAAE,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC;IACtB,CAAC;IAEM,+BAAO,GAAd;QACI,EAAE,CAAC,YAAY,CAAC,cAAc,CAAC,IAAI,CAAC,mBAAmB,CAAC,CAAC;QAEzD,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC;QAC1B,IAAI,CAAC,mBAAmB,GAAG,IAAI,CAAC;IACpC,CAAC;IArHa,qCAAuB,GAAU,CAAC,CAAC;IACnC,qCAAuB,GAAU,CAAC,CAAC;IACnC,kCAAoB,GAAU,CAAC,CAAC;IAChC,+BAAiB,GAAU,CAAC,CAAC;IAE3C,iCAAiC;IACnB,gCAAkB,GAAU,CAAC,CAAC;IAE5C,+BAA+B;IACjB,gCAAkB,GAAU,CAAC,CAAC;IAE9B,2BAAa,GAAU,CAAC,CAAC;IACzB,4BAAc,GAAU,CAAC,CAAC;IAC1B,6BAAe,GAAU,CAAC,CAAC;IAC3B,2BAAa,GAAU,CAAC,CAAC;IACzB,6BAAe,GAAU,EAAE,CAAC;IAuG9C,oBAAC;CAvHD,AAuHC,IAAA;kBAvHoB,aAAa","file":"","sourceRoot":"../../../../../assets/Script/Common","sourcesContent":["/**\r\n * Update\r\n *      let update:UpdateVersion = new UpdateVersion();\r\n *      update.updateHandler = this.upload.bind(this);\r\n *      update.completeHandler = this.uploadComplete.bind(this);\r\n *      this.pro.progress = 0.5;\r\n *      update.start(); \r\n *      this.up = update;\r\n *  } \r\n * \r\n *  upload(p:number, sum:number):void{\r\n *      if(p == NaN)\r\n *      {\r\n *          cc.log(\"The update progress value is nan\");\r\n *          return;\r\n *      }\r\n *      this.pro.progress = p;\r\n *  } \r\n * \r\n *  uploadComplete():void\r\n *  {\r\n *      this.pro.progress = 1;\r\n *  }\r\n */\r\nexport default class UpdateVersion {\r\n    public static ERROR_NO_LOCAL_MANIFEST:number = 0;\r\n    public static ERROR_DOWNLOAD_MANIFEST:number = 1;\r\n    public static ERROR_PARSE_MANIFEST:number = 2;\r\n    public static NEW_VERSION_FOUND:number = 3;\r\n\r\n    /** Already the latest version */\r\n    public static ALREADY_UP_TO_DATE:number = 4; \r\n\r\n    /** Download a selected file */\r\n    public static UPDATE_PROGRESSION:number = 5;\r\n\r\n    public static ASSET_UPDATED:number = 6;\r\n    public static ERROR_UPDATING:number = 7;\r\n    public static UPDATE_FINISHED:number = 8;\r\n    public static UPDATE_FAILED:number = 9;\r\n    public static ERROR_DECOMPRES:number = 10;\r\n\r\n    public updateHandler:any;\r\n    public completeHandler:any;\r\n\r\n    protected assetsManager:jsb.AssetsManager;\r\n    protected assetsEventListener:jsb.EventListenerAssetsManager;\r\n\r\n    constructor()\r\n    {\r\n    }\r\n\r\n    public start():void{\r\n        if(!cc || !cc.sys.isNative)\r\n        {\r\n            cc.log(\"NON APP\")\r\n            this.completeHandler && this.completeHandler();\r\n            return;\r\n        }\r\n\r\n        let url:string = \"http://192.168.1.185/app/cdn/niu9/project.manifest\";\r\n        let search:string = jsb.fileUtils.getWritablePath() + \"upload\";\r\n        console.log(\"Search path:\", search);\r\n\r\n        // Create AssetsManager\r\n        this.assetsManager = new jsb.AssetsManager(\"project.manifest\", search);\r\n        this.assetsEventListener = new jsb.EventListenerAssetsManager(this.assetsManager, this.event.bind(this));\r\n        cc.eventManager.addListener(this.assetsEventListener, 1);\r\n        this.assetsManager.update();\r\n\r\n        // Set search path\r\n        let hotUpdateSearchPaths = cc.sys.localStorage.getItem('HotUpdateSearchPaths'); \r\n        if(!hotUpdateSearchPaths)\r\n        {\r\n            // Initialised AssetsManager's local manifest is the cache directory's  manifest\r\n            hotUpdateSearchPaths = search;\r\n            // The default search path\r\n            var searchPaths:Array<string> = jsb.fileUtils.getSearchPaths();\r\n    \r\n            // hotUpdateSearchPaths Pre-positioning searchPaths at the beginning of the array\r\n            searchPaths.unshift(hotUpdateSearchPaths);\r\n\r\n            for(let v of searchPaths)\r\n            {\r\n                cc.log(v);\r\n            }\r\n    \r\n            jsb.fileUtils.setSearchPaths(searchPaths)\r\n            cc.sys.localStorage.setItem('HotUpdateSearchPaths', JSON.stringify(searchPaths));\r\n        }\r\n    }\r\n\r\n    protected event(e:jsb.EventAssetsManager):void{\r\n        console.log(\"**** event\", e.getEventCode(), e.getMessage());\r\n        switch(e.getEventCode())\r\n        {\r\n            case UpdateVersion.ERROR_NO_LOCAL_MANIFEST:\r\n                break;\r\n            case UpdateVersion.ERROR_DOWNLOAD_MANIFEST:\r\n                break;\r\n            case UpdateVersion.ERROR_PARSE_MANIFEST:\r\n                break;\r\n            case UpdateVersion.NEW_VERSION_FOUND:\r\n                break;\r\n            case UpdateVersion.ALREADY_UP_TO_DATE:\r\n                cc.log(\"Already the latest version \");\r\n                this.completeHandler != null && this.completeHandler();\r\n                break;\r\n            case UpdateVersion.UPDATE_PROGRESSION:\r\n                cc.log(\"Download: \", e.getPercent(), e.getTotalBytes(), this.updateHandler);\r\n                if(this.updateHandler != null)\r\n                {\r\n                    this.updateHandler(e.getPercent(), e.getTotalBytes());\r\n                }\r\n                break;\r\n            case UpdateVersion.ASSET_UPDATED:\r\n                break;\r\n            case UpdateVersion.ERROR_UPDATING:\r\n                break;\r\n            case UpdateVersion.UPDATE_FINISHED:\r\n                cc.log(\"Update completed！！\");\r\n                this.restart();\r\n                break;\r\n            case UpdateVersion.UPDATE_FAILED:\r\n                break;\r\n            case UpdateVersion.ERROR_DECOMPRES:\r\n                break;\r\n        }\r\n    }\r\n\r\n    public restart():void{\r\n        cc.audioEngine.stopAll();\r\n        this.destory();\r\n\r\n        cc.game.restart();\r\n    }\r\n\r\n    public destory():void{\r\n        cc.eventManager.removeListener(this.assetsEventListener);\r\n        \r\n        this.assetsManager = null;\r\n        this.assetsEventListener = null;\r\n    }\r\n}"]}